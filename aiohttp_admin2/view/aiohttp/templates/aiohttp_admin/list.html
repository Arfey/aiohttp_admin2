{% extends 'aiohttp_admin/base.html' %}
{% from "aiohttp_admin/pagination.html" import pagination %}

{% block main %}
<div class="wrapper">
{% include 'aiohttp_admin/list_action_buttons.html' %}

{% if message %}
<p class="alert alert-dark">{{ message }}</p>
{% endif %}

<div class="container">
    <div class="row">
        <div class="col-sm">
            <table class="table table-striped">
                <thead>
                    <tr>
                        {% with isDesc=(request.rel_url.query.get('sortDir') == 'desc') %}
                        {% for field in controller.inline_fields %}
                        <th scope="col">
                            {% if not hasattr(controller, "{}_field".format(field)) or hasattr(controller, "{}_field_sort".format(field)) %}
                            <!-- todo: delete pagination after sort  -->
                            <a href="{{ newParam({
                                'sort': field,
                                'sortDir': 'asc' if isDesc else 'desc',
                                'page': 1,
                            }, request.rel_url.query) }}">
                                {{ field }}
                                {% if request.rel_url.query.get('sort') == field %}
                                    {% if isDesc %}
                                    <i class="material-icons">arrow_upward</i>
                                    {% else %}
                                    <i class="material-icons">arrow_downward</i>
                                    {% endif %}
                                {% endif %}
                            </a>
                            {% else %}
                            {{ field }}
                            {% endif %}
                        </th>
                        {% endfor %}
                        {% endwith %}
                    </tr>
                </thead>
                <tbody>
                    {%- for obj in list.instances %}
                    <tr>
                        {% for field in controller.inline_fields %}
                        <td>
                            {% if loop.first %}
                            <input class="index-checkbox" type="checkbox" />
                            {% if controller.can_update %}
                            <a href="{{ url(detail_url, pk=obj.id) }}">
                            {% endif %}
                            {% endif %}
                            {% if hasattr(controller, "{}_field".format(field)) %}
                                {{ getattr(controller, "{}_field".format(field))(obj)|safe }}
                            {% else %}
                                {{ obj|attr(field) }}
                            {% endif %}
                            {% if loop.first %}
                            {% if controller.can_update %}
                            </a>
                            {% endif %}
                            {% endif %}
                        </th>
                        {% endfor %}
                    </tr>
                    {%- endfor %}
                </tbody>
            </table>
        </div>
        {% if controller.list_filter %}
        <nav class="filter-nav col-3">
            <p class="filter-nav-title">Filters</p>
            <div>
                {% for f in controller.list_filter %}
                    {% set field = controller.mapper({})._fields.get(f) %}
                    {% set filter = controller_view.default_filter_map.get(field.type_name) %}
                    {% if field and filter %}
                        <p class="filter-title">By {{ f }}</p>
                        {% from filter.template_name import filter as filter_macro with context %}

                        {{ filter_macro(field, filter(field.name, request.rel_url.query)) }}
                    {% endif %}
                {% endfor %}
            </div>
        </nav>
        {% endif %}
    </div>
</div>

<!-- pagination -->
<!-- todo: order -->
{{
    pagination(
        list.active_page,
        list.count,
        list.has_next,
        list.hex_prev,
        list.per_page,
        request.rel_url.query,
    )
}}
</div>

{% endblock %}
