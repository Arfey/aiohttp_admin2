{% extends 'aiohttp_admin/base.html' %}
{% from "aiohttp_admin/pagination.html" import pagination %}
{% from "aiohttp_admin/filters/search_filter.html" import search_filter with context %}

{% block main %}
<div class="wrapper">
{% include 'aiohttp_admin/list_action_buttons.html' %}

{% if message %}
<p class="alert alert-dark">{{ message }}</p>
{% endif %}

<div class="container">
    <div>
        {% if controller.search_fields %}
            {{ search_filter(controller_view.search_filter(controller.search_fields, request.rel_url.query)) }}
        {% endif %}
    </div>
    <div class="row">
        <div class="col-sm">
            <table class="table table-striped">
                {% include 'aiohttp_admin/list_header.html' %}
                <tbody>
                    {%- for obj in list.instances %}
                    <tr>
                        {% for field in controller.inline_fields %}
                        <td>
                            {% if loop.first %}
                            <input class="index-checkbox" type="checkbox" />
                            {% if controller.can_update %}
                            <a href="{{ url(detail_url, pk=obj.id) }}">
                            {% endif %}
                            {% endif %}
                            {% if hasattr(controller, "{}_field".format(field)) %}
                                {{ getattr(controller, "{}_field".format(field))(obj)|safe }}
                            {% else %}
                                {{ obj|attr(field) }}
                            {% endif %}
                            {% if loop.first %}
                            {% if controller.can_update %}
                            </a>
                            {% endif %}
                            {% endif %}
                        </th>
                        {% endfor %}
                    </tr>
                    {%- endfor %}
                </tbody>
            </table>
        </div>
        {% if controller.list_filter %}
        <nav class="filter-nav col-3">
            <p class="filter-nav-title">Filters</p>
            <div>
                {% for f in controller.list_filter %}
                    {% set field = controller.mapper({})._fields.get(f) %}
                    {% set filter = controller_view.default_filter_map.get(field.type_name) %}
                    {% if field and filter %}
                        <p class="filter-title">By {{ f }}</p>
                        {% from filter.template_name import filter as filter_macro with context %}

                        {{ filter_macro(field, filter(field.name, request.rel_url.query)) }}
                    {% endif %}
                {% endfor %}
            </div>
        </nav>
        {% endif %}
    </div>
</div>

<!-- pagination -->
<!-- todo: order -->
{{
    pagination(
        list.active_page,
        list.count,
        list.has_next,
        list.hex_prev,
        list.per_page,
        request.rel_url.query,
    )
}}
</div>

{% endblock %}
